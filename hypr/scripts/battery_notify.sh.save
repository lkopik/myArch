#!/bin/bash

# –ü–æ—Ä–æ–≥ –∑–∞—Ä—è–¥–∞ –±–∞—Ç–∞—Ä–µ–∏, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö)
THRESHOLD_MAIN=30
THRESHOLD_BACKUP=50
THRESHOLD_CRITICAL=5

# –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
NOTIFY_ID_MAIN=1000
NOTIFY_ID_BACKUP=1001

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —Å—Ç–∏–ª–µ "–ï–≤–∞–Ω–≥–µ–ª–∏–æ–Ω–∞"
send_notification() {
    local title="$1"
    local id="$2"
    local message="$3"
    notify-send -u critical -r "$id" -i "battery" "$title" "$message"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–∞—Ç–∞—Ä–µ—è—Ö
get_battery_info() {
    acpi -b | awk -v battery="$1" '
    {
        if ($2 == "Battery" battery) {
            level = gensub(/([0-9]+)%/, "\\1", "g", $4)
            status = $3
            print level, status
        }
    }'
}

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
while true; do
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∞—Ç–∞—Ä–µ—è—Ö
    BATTERY1_INFO=($(get_battery_info 0))
    BATTERY2_INFO=($(get_battery_info 1))

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –±–∞—Ç–∞—Ä–µ–∏
    if [[ ${BATTERY1_INFO[0]} -lt ${BATTERY2_INFO[0]} ]]; then
        BATTERY_LEVEL_MAIN=${BATTERY1_INFO[0]}
        BATTERY_STATUS_MAIN=${BATTERY1_INFO[1]}
        BATTERY_LEVEL_BACKUP=${BATTERY2_INFO[0]}
        BATTERY_STATUS_BACKUP=${BATTERY2_INFO[1]}
    else
        BATTERY_LEVEL_MAIN=${BATTERY2_INFO[0]}
        BATTERY_STATUS_MAIN=${BATTERY2_INFO[1]}
        BATTERY_LEVEL_BACKUP=${BATTERY1_INFO[0]}
        BATTERY_STATUS_BACKUP=${BATTERY1_INFO[1]}
    fi

    # –ï—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–∞—è –±–∞—Ç–∞—Ä–µ—è —Ä–∞–∑—Ä—è–∂–µ–Ω–∞ –¥–æ –ø–æ—Ä–æ–≥–∞
    if [[ $BATTERY_LEVEL_MAIN -le $THRESHOLD_MAIN ]]; then
        send_notification "‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —ç–Ω–µ—Ä–≥–∏–∏" "$NOTIFY_ID_MAIN" \
            "–£—Ä–æ–≤–µ–Ω—å –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞—Ç–∞—Ä–µ–∏: $BATTERY_LEVEL_MAIN%\n\n<b>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –ø–∏–ª–æ—Ç–æ–º –Ω–∞—Ä—É—à–µ–Ω–∞.</b> üö®"
    fi

    # –ï—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–∞—è –±–∞—Ç–∞—Ä–µ—è —Ä–∞–∑—Ä—è–∂–µ–Ω–∞ –¥–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è
    if [[ $BATTERY_LEVEL_MAIN -le $THRESHOLD_CRITICAL ]]; then
        send_notification "üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –£–†–û–í–ï–ù–¨: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫" "$NOTIFY_ID_MAIN" \
            "–£—Ä–æ–≤–µ–Ω—å –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞—Ç–∞—Ä–µ–∏: $BATTERY_LEVEL_MAIN%\n\n<b>–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –∞–≤–∞—Ä–∏–π–Ω—ã–π —Ä–µ–∂–∏–º.</b> ‚ö°"
    fi

    # –ï—Å–ª–∏ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –±–∞—Ç–∞—Ä–µ—è —Ä–∞–∑—Ä—è–∂–µ–Ω–∞ –¥–æ –ø–æ—Ä–æ–≥–∞
    if [[ $BATTERY_LEVEL_BACKUP -le $THRESHOLD_BACKUP ]]; then
        send_notification "üî¥ –ê–í–ê–†–ò–Ø: –†–µ–∑–µ—Ä–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –Ω–∞ –ø—Ä–µ–¥–µ–ª–µ" "$NOTIFY_ID_BACKUP" \
            "–£—Ä–æ–≤–µ–Ω—å —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –±–∞—Ç–∞—Ä–µ–∏: $BATTERY_LEVEL_BACKUP%\n\n<b>–¢–†–ï–í–û–ì–ê: –°–∏—Å—Ç–µ–º–∞ –±–ª–∏–∑–∫–∞ –∫ –æ—Ç–∫–ª—é—á–µ–Ω–∏—é.</b> üí•"
    fi

    # –í—ã–≤–æ–¥–∏–º —Ç–µ–∫—É—â–∏–µ —É—Ä–æ–≤–Ω–∏ –±–∞—Ç–∞—Ä–µ–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    echo "–û—Å–Ω–æ–≤–Ω–∞—è –±–∞—Ç–∞—Ä–µ—è: $BATTERY_LEVEL_MAIN% (${BATTERY_STATUS_MAIN})"
    echo "–†–µ–∑–µ—Ä–≤–Ω–∞—è –±–∞—Ç–∞—Ä–µ—è: $BATTERY_LEVEL_BACKUP% (${BATTERY_STATUS_BACKUP})"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 300 —Å–µ–∫—É–Ω–¥
    sleep 300
done
